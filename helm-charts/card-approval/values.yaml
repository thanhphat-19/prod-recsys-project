# Umbrella chart for Card Approval Prediction API
# This combines PostgreSQL, Redis, and FastAPI into a single deployment

# Global namespace for all components
namespace: card-approval

# PostgreSQL configuration
postgres:
  enabled: true

  # Database configuration
  database: card_approval_db
  username: app_user
  password: phatngothanh19  # TODO: Use Kubernetes secrets!

  service:
    port: 5432

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Persistent storage configuration
  persistence:
    enabled: true
    storageClass: "standard-rwo"
    size: 5Gi
    reclaimPolicy: Retain

# Redis configuration
redis:
  enabled: true

  service:
    port: 6379

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  persistence:
    enabled: true
    storageClass: "standard-rwo"
    size: 1Gi
    reclaimPolicy: Retain

  config:
    save: "900 1 300 10 60 10000"
    maxmemory: "256mb"
    maxmemoryPolicy: "allkeys-lru"

# Card Approval API configuration
api:
  enabled: true

  image:
    repository: us-east1-docker.pkg.dev/product-recsys-mlops/product-recsys-mlops-recsys/card-approval-api
    tag: "latest"
    pullPolicy: Always

  replicaCount: 2

  service:
    type: ClusterIP
    port: 80
    targetPort: 8000

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  config:
    appName: "Card Approval API"
    appVersion: "1.0.0"
    logLevel: "INFO"
    modelName: "card_approval_model"
    modelStage: "Production"

  # MLflow connection - points to existing recsys-training MLflow
  mlflow:
    trackingUri: "http://recsys-training-mlflow.recsys-training.svc.cluster.local:5000"

  # PostgreSQL connection (matches postgres config above)
  postgres:
    host: "card-approval-postgres"
    port: 5432
    database: "card_approval_db"
    username: "app_user"
    password: "phatngothanh19"  # TODO: Match above!

  # Redis connection (matches redis config above)
  redis:
    host: "card-approval-redis"
    port: 6379

  # Workload Identity for GCS/MLflow access
  serviceAccount:
    create: true
    name: card-approval-api-sa
    annotations:
      # TODO: Setup after deployment if needed for model access
      iam.gke.io/gcp-service-account: ""

  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Ingress (optional - for external access)
  ingress:
    enabled: false
    className: "nginx"
    host: "card-approval-api.example.com"
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"

  # Prometheus monitoring
  monitoring:
    enabled: true
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      prometheus.io/path: "/metrics"
